generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model JobPosition {
  id           String     @id @default(uuid())
  jobName      String
  code         String
  description  String?
  positionId   String
  departmentId String
  officeId     String
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  office       Office     @relation(fields: [officeId], references: [id], onDelete: Cascade)
  position     Position   @relation(fields: [positionId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([positionId, jobName, departmentId])
  @@index([departmentId])
  @@index([positionId])
  @@index([isActive])
  @@index([officeId])
  @@map("job_positions")
}

model Office {
  id           String        @id @default(uuid())
  name         String        @unique
  type         OfficeType
  description  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  departments  Department[]
  jobPositions JobPosition[]
  users        User[]
  worksheets   WorkSheet[] // Office = Factory for FACTORY_OFFICE type

  @@index([type])
  @@map("offices")
}

model Department {
  id           String                     @id @default(uuid())
  name         String
  description  String?
  officeId     String
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  office       Office                     @relation(fields: [officeId], references: [id], onDelete: Cascade)
  jobPositions JobPosition[]
  managers     UserDepartmentManagement[]
  teams        Team[] // Department = Line (for factory departments)

  @@unique([name, officeId])
  @@index([officeId])
  @@map("departments")
}

model Position {
  id               String        @id @default(uuid())
  name             String        @unique
  description      String?
  level            Int           @default(0)
  priority         Int           @default(0)
  isManagement     Boolean       @default(false)
  isReportable     Boolean       @default(true)
  canViewHierarchy Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  jobPositions     JobPosition[]

  @@map("positions")
}

model User {
  id                 String                     @id @default(uuid())
  employeeCode       String                     @unique
  email              String?                    @unique
  password           String
  firstName          String
  lastName           String
  phone              String?
  avatar             String?
  dateOfBirth        DateTime?                  @db.Date
  address            String?
  sex                Sex?
  roles              UserRole[]                 @relation("UserRoles") // Multiple roles support
  jobPositionId      String
  isActive           Boolean                    @default(false)
  officeId           String
  groupId            String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  attendanceEvents   AttendanceEvent[]
  gatePassApprovals  GatePassApproval[]         @relation("GatePassApprovals")
  gatePasses         GatePass[]
  ledGroups          Group[]                    @relation("GroupLeader")
  reports            Report[]
  evaluations        TaskEvaluation[]
  managedDepartments UserDepartmentManagement[] @relation("UserToManagedDepartments")
  group              Group?                     @relation("GroupMembers", fields: [groupId], references: [id])
  jobPosition        JobPosition                @relation(fields: [jobPositionId], references: [id])
  office             Office                     @relation(fields: [officeId], references: [id])
  myWorkSheets       WorkSheet[]                @relation("WorkerWorkSheets") // Phiếu công của mình
  updatedWorkRecords WorkSheetRecord[]          @relation("WorkRecordUpdater") // Nhóm trưởng cập nhật
  createdWorkSheets  WorkSheet[]                @relation("WorkSheetCreator") // Quản trị line tạo
  pushSubscriptions  PushSubscription[]         @relation("UserPushSubscriptions")

  medicalRecordsAsPatient MedicalRecord[]       @relation("PatientMedicalRecords")
  medicalRecordsAsDoctor  MedicalRecord[]       @relation("DoctorMedicalRecords")
  prescriptionsDispensed  MedicalPrescription[] @relation("MedicineDispenser")

  @@index([jobPositionId])
  @@index([officeId])
  @@index([isActive])
  @@index([firstName, lastName])
  @@index([groupId])
  @@map("users")
}

model Report {
  id          String       @id @default(uuid())
  weekNumber  Int
  year        Int
  userId      String
  isCompleted Boolean      @default(false)
  isLocked    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tasks       ReportTask[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([weekNumber, year, userId])
  @@index([userId])
  @@index([year, weekNumber])
  @@index([isCompleted])
  @@index([isLocked])
  @@index([createdAt])
  @@map("reports")
}

model ReportTask {
  id            String           @id @default(uuid())
  reportId      String
  taskName      String
  monday        Boolean          @default(false)
  tuesday       Boolean          @default(false)
  wednesday     Boolean          @default(false)
  thursday      Boolean          @default(false)
  friday        Boolean          @default(false)
  saturday      Boolean          @default(false)
  isCompleted   Boolean          @default(false)
  reasonNotDone String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  report        Report           @relation(fields: [reportId], references: [id], onDelete: Cascade)
  evaluations   TaskEvaluation[]

  @@index([reportId])
  @@index([isCompleted])
  @@map("report_tasks")
}

model TaskEvaluation {
  id                     String         @id @default(uuid())
  taskId                 String
  evaluatorId            String
  originalIsCompleted    Boolean        @default(false)
  evaluatedIsCompleted   Boolean        @default(false)
  originalReasonNotDone  String?
  evaluatedReasonNotDone String?
  evaluatorComment       String?
  evaluationType         EvaluationType @default(REVIEW)
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  evaluator              User           @relation(fields: [evaluatorId], references: [id], onDelete: Cascade)
  task                   ReportTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, evaluatorId])
  @@index([taskId])
  @@index([evaluatorId])
  @@index([evaluationType])
  @@index([createdAt])
  @@map("task_evaluations")
}

model UserDepartmentManagement {
  id           String     @id @default(uuid())
  userId       String
  departmentId String
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user         User       @relation("UserToManagedDepartments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
  @@map("user_department_managements")
}

model Team {
  id           String     @id @default(uuid())
  name         String
  code         String
  description  String?
  departmentId String // Department = Line (for production departments)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  groups       Group[]
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([code, departmentId])
  @@index([departmentId])
  @@index([isActive])
  @@map("teams")
}

model Group {
  id          String      @id @default(uuid())
  name        String
  code        String
  description String?
  teamId      String
  leaderId    String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  leader      User?       @relation("GroupLeader", fields: [leaderId], references: [id])
  team        Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  members     User[]      @relation("GroupMembers")
  worksheets  WorkSheet[]

  @@unique([code, teamId])
  @@index([teamId])
  @@index([leaderId])
  @@index([isActive])
  @@map("groups")
}

model Product {
  id                   String                @id @default(uuid())
  name                 String
  code                 String                @unique
  description          String?
  imageUrl             String?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  processes            ProductProcess[]
  worksheets           WorkSheet[]
  worksheetRecordItems WorkSheetRecordItem[]

  @@index([isActive])
  @@index([code])
  @@map("products")
}

model Process {
  id                   String                @id @default(uuid())
  name                 String
  code                 String                @unique
  description          String?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  products             ProductProcess[]
  worksheets           WorkSheet[]
  worksheetRecordItems WorkSheetRecordItem[]

  @@index([isActive])
  @@index([code])
  @@map("processes")
}

model ProductProcess {
  id                    String   @id @default(uuid())
  productId             String
  processId             String
  standardOutputPerHour Int
  standardWorkers       Int      @default(1)
  sequence              Int      @default(0)
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  process               Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  product               Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, processId])
  @@index([productId])
  @@index([processId])
  @@index([isActive])
  @@map("product_processes")
}

model WorkSheet {
  id               String            @id @default(uuid())
  date             DateTime          @db.Date
  workerId         String // Công nhân - mỗi phiếu chỉ cho 1 người
  groupId          String // Nhóm của công nhân
  officeId         String // Office (= Factory for FACTORY_OFFICE type)
  productId        String // Mã túi xách
  processId        String // Công đoạn (chặt, lạng, dán,...)
  shiftType        ShiftType // Ca làm việc
  plannedOutput    Int // SLKH - Sản lượng kế hoạch/giờ của công nhân này
  createdById      String // Người tạo (quản trị line/department)
  status           WorkSheetStatus   @default(ACTIVE)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  attendanceEvents AttendanceEvent[]
  records          WorkSheetRecord[] // Records theo giờ
  createdBy        User              @relation("WorkSheetCreator", fields: [createdById], references: [id])
  office           Office            @relation(fields: [officeId], references: [id])
  group            Group             @relation(fields: [groupId], references: [id])
  worker           User              @relation("WorkerWorkSheets", fields: [workerId], references: [id])
  product          Product           @relation(fields: [productId], references: [id])
  process          Process           @relation(fields: [processId], references: [id])

  @@unique([date, workerId]) // Mỗi công nhân chỉ có 1 phiếu/ngày
  @@index([date])
  @@index([workerId])
  @@index([groupId])
  @@index([officeId])
  @@index([createdById])
  @@index([status])
  @@index([productId, processId])
  @@map("worksheets")
}

// Xóa model WorkSheetItem vì không cần thiết nữa
// Phiếu công đoạn đã là cá nhân rồi

model WorkSheetRecord {
  id            String                 @id @default(uuid())
  worksheetId   String
  workHour      Int // Giờ thứ mấy trong ca (1-8, 1-9.5, 1-11)
  startTime     DateTime               @db.Time(6)
  endTime       DateTime               @db.Time(6)
  plannedOutput Int? // SLKH tổng - Sản lượng kế hoạch của giờ này
  actualOutput  Int? // SLTH tổng - Tổng sản lượng thực hiện (sum of items)
  status        WorkRecordStatus       @default(PENDING)
  updatedById   String? // Nhóm trưởng nhập liệu
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  items         WorkSheetRecordItem[] // Chi tiết các mã túi làm trong giờ này
  causes        WorkSheetRecordCause[] // Nguyên nhân (VT, CN, CL, MM, khác)
  updatedBy     User?                  @relation("WorkRecordUpdater", fields: [updatedById], references: [id])
  worksheet     WorkSheet              @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  @@unique([worksheetId, workHour])
  @@index([worksheetId])
  @@index([workHour])
  @@index([status])
  @@map("worksheet_records")
}

model WorkSheetRecordItem {
  id             String          @id @default(uuid())
  recordId       String
  entryIndex     Int             @default(1) // Thứ tự entry (1, 2, 3,... nếu làm nhiều mã túi)
  productId      String // Mã túi cho entry này
  processId      String // Công đoạn cho entry này
  plannedOutput  Int? // SLKH - Sản lượng kế hoạch của entry này
  actualOutput   Int             @default(0) // SLTH - Sản lượng thực hiện của entry này
  efficiencyRate Float? // % = (actualOutput / plannedOutput) * 100
  note           String? // Ghi chú cho entry này
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  product        Product         @relation(fields: [productId], references: [id])
  process        Process         @relation(fields: [processId], references: [id])
  record         WorkSheetRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([recordId, entryIndex])
  @@index([recordId])
  @@index([productId, processId])
  @@map("worksheet_record_items")
}

// Xóa model WorkSheetItemRecord - không cần thiết
// Thông tin đã có trong WorkSheetRecord

model WorkSheetRecordCause {
  id        String          @id @default(uuid())
  recordId  String
  cause     CauseType
  delta     Int
  note      String?
  createdAt DateTime        @default(now())
  record    WorkSheetRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([recordId, cause])
  @@index([recordId])
  @@map("worksheet_record_causes")
}

model WorkSheetMonthlyBackup {
  id              String   @id @default(uuid())
  month           Int
  year            Int
  officeId        String // Office = Factory
  groupId         String
  totalWorksheets Int
  totalOutput     Int
  avgEfficiency   Float
  backupData      Json
  createdAt       DateTime @default(now())

  @@unique([month, year, officeId, groupId])
  @@index([year, month])
  @@index([officeId])
  @@map("worksheet_monthly_backups")
}

model AttendanceEvent {
  id          String              @id @default(uuid())
  worksheetId String
  userId      String
  eventType   AttendanceEventType
  minutes     Int
  hourStart   Int?
  hourEnd     Int?
  note        String?
  createdAt   DateTime            @default(now())
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  worksheet   WorkSheet           @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  @@index([worksheetId])
  @@index([userId])
  @@index([eventType])
  @@map("attendance_events")
}

model GatePass {
  id            String             @id @default(uuid())
  passNumber    String             @unique
  userId        String
  reasonType    GatePassReason
  reasonDetail  String?
  startDateTime DateTime
  endDateTime   DateTime
  status        GatePassStatus     @default(PENDING)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  approvals     GatePassApproval[]
  user          User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startDateTime])
  @@map("gate_passes")
}

model GatePassApproval {
  id            String                 @id @default(uuid())
  gatePassId    String
  approverId    String
  approvalLevel Int
  status        GatePassApprovalStatus @default(PENDING)
  approvedAt    DateTime?
  rejectedAt    DateTime?
  comment       String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  approver      User                   @relation("GatePassApprovals", fields: [approverId], references: [id])
  gatePass      GatePass               @relation(fields: [gatePassId], references: [id], onDelete: Cascade)

  @@unique([gatePassId, approvalLevel])
  @@index([gatePassId])
  @@index([approverId])
  @@map("gate_pass_approvals")
}

// -------------------------------------Medical Management-------------------------------------
// 1. Quản lý thuốc cơ bản
// Danh mục y tế (bao gồm: thuốc, vật tư y tế, cấp cứu)
model MedicineCategory {
  id          String     @id @default(uuid())
  code        String     @unique // "I", "II", "IX", "XIII", "XV", "XVI", "XVII"
  name        String // "NHÓM THUỐC HẠ SỐT...", "CẤP CỨU", "VẬT TƯ Y TẾ"
  type        MedicalItemType @default(MEDICINE) // Loại: MEDICINE, EMERGENCY_SUPPLY, MEDICAL_EQUIPMENT
  description String?
  sortOrder   Int        @default(0) // Thứ tự hiển thị
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  medicines   Medicine[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("medicine_categories")
}

model Medicine {
  id           String                @id @default(uuid())
  name         String // Tên thuốc/vật tư y tế
  type         MedicalItemType       @default(MEDICINE) // MEDICINE, EMERGENCY_SUPPLY, MEDICAL_EQUIPMENT
  categoryId   String? // Thuộc nhóm nào (I-XVII)
  route        String? // Đường dùng: "UỐNG", "NHỎ MẮT", "BÔI", "DÁN" (chỉ cho MEDICINE)
  strength     String? // Hàm lượng: "500mg", "10ml"
  manufacturer String? // Nơi sản xuất
  dosage       String? // Liều dùng: ví dụ "2 viên", "1 thìa" (chỉ cho MEDICINE)
  frequency    String? // Tần suất: "sáng", "tối", "sáng-tối", "3 lần/ngày" (chỉ cho MEDICINE)
  instructions String? // Hướng dẫn: "sau ăn", "trước ăn", "khi đói"
  units        String? // Đơn vị tính: "viên", "chai", "lọ", "hộp", "cái", "miếng"
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  category            MedicineCategory?     @relation(fields: [categoryId], references: [id])
  prescriptions       MedicalPrescription[]
  inventoryBalances   MedicineInventory[] // Tồn kho theo tháng
  inventoryTransactions InventoryTransaction[] // Lịch sử xuất/nhập

  @@index([isActive])
  @@index([name])
  @@index([type])
  @@index([categoryId])
  @@index([type, categoryId])
  @@map("medicines")
}

// 2. Lịch sử khám bệnh (đơn giản hóa)
model MedicalRecord {
  id        String   @id @default(uuid())
  patientId String // ID nhân viên khám
  doctorId  String // ID nhân viên y tế
  visitDate DateTime @default(now())
  symptoms  String? // Triệu chứng
  diagnosis String? // Chẩn đoán
  notes     String? // Ghi chú
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  patient       User                  @relation("PatientMedicalRecords", fields: [patientId], references: [id])
  doctor        User                  @relation("DoctorMedicalRecords", fields: [doctorId], references: [id])
  prescriptions MedicalPrescription[]

  @@index([patientId])
  @@index([doctorId])
  @@index([visitDate])
  @@map("medical_records")
}

// 3. Đơn thuốc
model MedicalPrescription {
  id              String    @id @default(uuid())
  medicalRecordId String
  medicineId      String
  quantity        Int // Số lượng cấp
  dosage          String? // Liều dùng: "2 viên/lần", "1 thìa"
  frequency       String? // Tần suất: "sáng", "tối", "sáng-tối", "3 lần/ngày"
  strength        String? // Hàm lượng: 500mg
  duration        String? // Thời gian dùng: 2 ngày
  instructions    String? // Hướng dẫn sử dụng
  notes           String? // Ghi chú
  isDispensed     Boolean   @default(false) // Đã cấp thuốc chưa
  dispensedAt     DateTime? // Thời gian cấp thuốc
  dispensedBy     String? // Người cấp thuốc
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  medicine      Medicine      @relation(fields: [medicineId], references: [id])
  dispenser     User?         @relation("MedicineDispenser", fields: [dispensedBy], references: [id])

  @@index([medicalRecordId])
  @@index([medicineId])
  @@index([isDispensed])
  @@map("medical_prescriptions")
}

// 4. Quản lý tồn kho thuốc theo tháng
model MedicineInventory {
  id                    String    @id @default(uuid())
  medicineId            String
  month                 Int // 1-12
  year                  Int // 2024, 2025
  expiryDate            DateTime? @db.Date // Hạn sử dụng
  
  // Tồn đầu kỳ
  openingQuantity       Decimal   @default(0) @db.Decimal(30, 20) // Số lượng
  openingUnitPrice      Decimal   @default(0) @db.Decimal(30, 20) // Đơn giá
  openingTotalAmount    Decimal   @default(0) @db.Decimal(30, 20) // Thành tiền
  
  // Phát sinh trong tháng - Nhập
  monthlyImportQuantity   Decimal @default(0) @db.Decimal(30, 20)
  monthlyImportUnitPrice  Decimal @default(0) @db.Decimal(30, 20)
  monthlyImportAmount     Decimal @default(0) @db.Decimal(30, 20)
  
  // Phát sinh trong tháng - Xuất
  monthlyExportQuantity   Decimal @default(0) @db.Decimal(30, 20)
  monthlyExportUnitPrice  Decimal @default(0) @db.Decimal(30, 20)
  monthlyExportAmount     Decimal @default(0) @db.Decimal(30, 20)
  
  // Tồn cuối kỳ
  closingQuantity       Decimal   @default(0) @db.Decimal(30, 20)
  closingUnitPrice      Decimal   @default(0) @db.Decimal(30, 20)
  closingTotalAmount    Decimal   @default(0) @db.Decimal(30, 20)
  
  // Lũy kế năm - Nhập
  yearlyImportQuantity  Decimal   @default(0) @db.Decimal(30, 20)
  yearlyImportUnitPrice Decimal   @default(0) @db.Decimal(30, 20)
  yearlyImportAmount    Decimal   @default(0) @db.Decimal(30, 20)
  
  // Lũy kế năm - Xuất
  yearlyExportQuantity  Decimal   @default(0) @db.Decimal(30, 20)
  yearlyExportUnitPrice Decimal   @default(0) @db.Decimal(30, 20)
  yearlyExportAmount    Decimal   @default(0) @db.Decimal(30, 20)
  
  // Đề nghị mua tháng sau
  suggestedPurchaseQuantity  Decimal @default(0) @db.Decimal(30, 20)
  suggestedPurchaseUnitPrice Decimal @default(0) @db.Decimal(30, 20)
  suggestedPurchaseAmount    Decimal @default(0) @db.Decimal(30, 20)
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  medicine Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  
  @@unique([medicineId, month, year])
  @@index([medicineId])
  @@index([month, year])
  @@index([year])
  @@map("medicine_inventories")
}

// 5. Lịch sử giao dịch xuất/nhập kho
model InventoryTransaction {
  id                String              @id @default(uuid())
  medicineId        String
  type              InventoryTransactionType // IMPORT, EXPORT, ADJUSTMENT
  quantity          Decimal             @db.Decimal(30, 20)
  unitPrice         Decimal             @db.Decimal(30, 20)
  totalAmount       Decimal             @db.Decimal(30, 20)
  transactionDate   DateTime            @default(now())
  
  // Thông tin liên quan
  referenceType     String? // "MEDICAL_RECORD", "PURCHASE_ORDER", "MANUAL"
  referenceId       String? // ID của medical record hoặc purchase order
  
  expiryDate        DateTime?           @db.Date // Hạn sử dụng (cho nhập kho)
  batchNumber       String? // Số lô (cho nhập kho)
  supplier          String? // Nhà cung cấp (cho nhập kho)
  
  notes             String?
  createdBy         String? // User ID người tạo giao dịch
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  medicine Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  
  @@index([medicineId])
  @@index([type])
  @@index([transactionDate])
  @@index([referenceType, referenceId])
  @@map("inventory_transactions")
}

enum MedicalItemType {
  MEDICINE           // Thuốc (I-XIV, XVII)
  EMERGENCY_SUPPLY   // Cấp cứu (XV)
  MEDICAL_EQUIPMENT  // Vật tư y tế (XVI)
}

enum InventoryTransactionType {
  IMPORT       // Nhập kho
  EXPORT       // Xuất kho (kê đơn)
  ADJUSTMENT   // Điều chỉnh (kiểm kê, hỏng hóc)
}


enum ShiftType {
  NORMAL_8H
  EXTENDED_9_5H
  OVERTIME_11H
}

enum WorkSheetStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum WorkRecordStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum Sex {
  MALE
  FEMALE
  OTHER
}

enum OfficeType {
  HEAD_OFFICE
  FACTORY_OFFICE
}

enum EvaluationType {
  REVIEW
  APPROVAL
  REJECTION
}

enum CauseType {
  MATERIALS
  TECHNOLOGY
  QUALITY
  MACHINERY
  OTHER
}

enum AttendanceEventType {
  LATE
  EARLY_LEAVE
  ABSENT
  REASSIGNMENT
  BREAK
  OTHER
}

enum GatePassReason {
  BUSINESS
  DISCIPLINE
  SICK
  PERSONAL
  OTHER
}

enum GatePassStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  USED
  CANCELLATION_REQUESTED
}

enum GatePassApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String
  p256dhKey String
  authKey   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// ========== RBAC SYSTEM ==========

// ⭐ NEW: Dynamic Roles Table
model RoleDefinition {
  id          String   @id @default(uuid())
  name        String   @unique // "ADMIN", "MANAGER", "TEAM_LEADER", etc.
  code        String   @unique // Internal code for system
  description String?
  isSystem    Boolean  @default(false) // true for SUPERADMIN, ADMIN, USER, WORKER, MEDICAL_STAFF
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions     RoleDefinitionPermission[]
  userAssignments UserRole[]

  @@index([isActive])
  @@index([isSystem])
  @@map("role_definitions")
}

// ⭐ NEW: Many-to-Many relationship between RoleDefinition and Permission
model RoleDefinitionPermission {
  id               String         @id @default(uuid())
  roleDefinitionId String
  permissionId     String
  isGranted        Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  roleDefinition RoleDefinition @relation(fields: [roleDefinitionId], references: [id], onDelete: Cascade)
  permission     Permission     @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleDefinitionId, permissionId])
  @@index([roleDefinitionId])
  @@index([permissionId])
  @@map("role_definition_permissions")
}

// ⭐ NEW: Many-to-Many relationship between User and RoleDefinition
model UserRole {
  id               String   @id @default(uuid())
  userId           String
  roleDefinitionId String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user           User           @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  roleDefinition RoleDefinition @relation(fields: [roleDefinitionId], references: [id], onDelete: Cascade)

  @@unique([userId, roleDefinitionId])
  @@index([userId])
  @@index([roleDefinitionId])
  @@index([isActive])
  @@map("user_roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // users, reports, factories, lines, teams, groups, worksheets, products, processes, medicines, medical-records
  action      String // view, create, update, delete, approve, manage, assign
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roleDefinitionPermissions RoleDefinitionPermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

// ========== ANONYMOUS FEEDBACK SYSTEM ==========

model Feedback {
  id        String   @id @default(uuid())
  content   String   @db.Text
  ipAddress String?  // Track IP for spam prevention
  userAgent String?  // Track browser/device info
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("feedbacks")
}
